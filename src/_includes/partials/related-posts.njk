{% set relatedPosts = [] %}
{% set currentTags = tags | default([]) %}
{% set currentUrl = page.url %}

{%- for post in collections.allPosts -%}
  {%- if post.url != currentUrl and not post.data.draft -%}
    {%- set commonTags = [] -%}
    {%- for tag in currentTags -%}
      {%- if tag != 'posts' and post.data.tags and tag in post.data.tags -%}
        {%- set commonTags = (commonTags.push(tag), commonTags) -%}
      {%- endif -%}
    {%- endfor -%}
    {%- if commonTags.length > 0 -%}
      {%- set relatedPosts = (relatedPosts.push({
        'url': post.url,
        'title': post.data.title,
        'description': post.data.description,
        'date': post.date,
        'tags': post.data.tags,
        'commonTags': commonTags.length
      }), relatedPosts) -%}
    {%- endif -%}
  {%- endif -%}
{%- endfor -%}

{%- if relatedPosts.length > 0 -%}
  {%- set limitedRelated = relatedPosts | slice(0, 3) -%}
  <section class="related-posts region region-space-m">
    <h2 class="text-step-2">Related Posts</h2>
    <ul class="related-posts-list" role="list" style="list-style: none; padding: 0;">
      {%- for post in limitedRelated -%}
      <li class="related-post-item">
        <article>
          <h3 class="related-post-title">
            <a href="{{ post.url }}">{{ post.title }}</a>
          </h3>
          {% if post.description %}
          <p class="related-post-description">{{ post.description }}</p>
          {% endif %}
          <time class="related-post-date" datetime="{{ post.date | formatDate('yyyy-MM-dd') }}">
            {{ post.date | formatDate('MMM dd, yyyy') }}
          </time>
        </article>
      </li>
      {%- endfor -%}
    </ul>
  </section>
{%- endif -%}
